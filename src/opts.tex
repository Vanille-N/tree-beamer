\section{Optimizations}

\subsection{Possible optimizations}

\newcommand{\assumepath}[2]{\textover{\visible<#1>{\color{magenta}{#2}}}{}}

\begin{frame}[fragile, t]
    \frametitle{Swap write-write}

    \begin{onlyenv}<1-3>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;
*x = 42; // (optimization: move down ?)
*y = 19; // is this a foreign write ? @\assumepath{2}{if not}\assumepath{3}{if yes}@

*x = 57;
            \end{lstlisting}
        \end{block}%
        \includegraphics<1>{blank.base.pdf}%
        \includegraphics<2>{path.base.mut+cw+cw.pdf}%
        \includegraphics<3>{path.base.mut+cw+fw+cw.pdf}%
    \end{onlyenv}

    \begin{onlyenv}<4>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;

*y = 19; // assumed not to be a foreign write
*x = 42;
*x = 57;
            \end{lstlisting}
        \end{block}
        \includegraphics{path.base.mut+cw+cw.pdf}
    \end{onlyenv}

    \begin{onlyenv}<5>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;

*y = 19; // assumed not to be a foreign write

*x = 57;
            \end{lstlisting}
        \end{block}
        \includegraphics{path.base.mut+cw.pdf}
    \end{onlyenv}
\end{frame}

\begin{frame}
    \frametitle{Some standard optimizations}
    Stacked Borrows (SB): predecessor of TB, has the same purpose
    but was ruled too strict.\\~\\

    \newcommand{\asterisk}{\textsuperscript{*}}
    \newcommand{\noasterisk}{\phantom{\asterisk}}
    \begin{tabular}{|l|c|c|l}
        \cline{1-3}
        Possible in...                     & SB     & TB &\\
        \cline{1-3}
        Swap call-read \(\to\) read-call (speculative)
            & \cmark\noasterisk
            & \cmark\noasterisk
            &\\
        \cline{1-3}
        Swap read-call \(\to\) call-read
            & \cmark\asterisk
            & \cmark\asterisk
            &\\
        \(\triangleright\)\scriptsize~ Swap read-read' \(\to\) read'-read
            & \scriptsize \cmark\asterisk
            & \scriptsize \cmark\noasterisk
            & \visible<3>{\(\gets\) TB only}\\
        \cline{1-3}
        Swap call-write \(\to\) write-call (speculative)
            & \cmark\asterisk
            & \xmark\noasterisk
            & \visible<2>{\(\gets\) SB only}\\
        \(\triangleright\)\scriptsize~ Swap write-call-write \(\to\) write-write-call
            & \scriptsize \cmark\asterisk
            & \scriptsize \cmark\asterisk
            &\\
        \cline{1-3}
        Swap write-call \(\to\) call-write
            & \cmark\asterisk
            & \cmark\asterisk
            &\\
        \(\triangleright\)\scriptsize~ Swap write-read'-read \(\to\) read'-write-read
            & \scriptsize \cmark\noasterisk
            & \scriptsize \cmark\asterisk
            & \visible<2>{\(\gets\) SB only}\\
        \cline{1-3}
    \end{tabular}~\\~\\

    {\footnotesize
    all are possible for references without interior mutability\\
    (\texttt{\&mut} if a write is involved, both \texttt{\&} and \texttt{\&mut} if read-only)\\
    \asterisk: only for protected references\\
    }
\end{frame}

