\section{Optimizations}

\begin{frame}
    % FIXME: change to read-call
    \frametitle{Some standard optimizations}
    \begin{tabular}{|l|c|c|l}
        Possible in...                     & SB     & TB \\
        Insert speculative read            & \cmark & \cmark &\\
        Insert speculative write           & \cmark & \xmark &\visible<2>{\(\gets\)}\\
        Remove redundant read              & \cmark & \cmark &\\
        Remove redundant write             & \cmark & \cmark &\\
        Reorder read-write                 & \cmark & \xmark &\visible<2>{\(\gets\)}\\
        Reorder read-write (fn args)       & \cmark & \cmark &\\
        Reorder read-read                  & \xmark & \cmark &\visible<3>{\(\gets\)}\\
        Reorder read-read (fn args)        & \cmark & \cmark &\\
        Reorder write-write                & \cmark & \cmark &\\
        Reorder write-write (fn args)      & \cmark & \cmark &\\
        Reorder write-read                 & \cmark & \cmark &\\
        Reorder write-read (fn args)       & \cmark & \cmark &\\
        Reorder reborrow-reborrow          & \xmark & \cmark &\visible<3>{\(\gets\)}\\
    \end{tabular}
\end{frame}

\subsection{Possible optimizations}

\begin{frame}[fragile, t]
    \frametitle{Reorder write-write}

    \begin{onlyenv}<1-3>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;
*x = 42; // (optimization: move down ?)
*y = 19; // is this a foreign write ?

*x = 57;
            \end{lstlisting}
        \end{block}%
        \includegraphics<1>{sm-baseline-blank.pdf}%
        \includegraphics<2>{sm-path-res+act+Wact.pdf}%
        \includegraphics<3>{sm-path-res+act+dis+Wub.pdf}%
    \end{onlyenv}

    \begin{onlyenv}<4>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;

*y = 19; // assumed not to be a foreign write
*x = 42;
*x = 57;
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-res+act+Wact.pdf}
    \end{onlyenv}

    \begin{onlyenv}<5>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;

*y = 19; // assumed not to be a foreign write

*x = 57;
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-res+act.pdf}
    \end{onlyenv}
\end{frame}

\begin{frame}[fragile, t]
    \frametitle{Insert speculative read}
    \begin{onlyenv}<1-4>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust]
fn read(x: &u64) -> u64 {

    opaque(/* maybe foreign write */);
    *x // (optimization: move up ?)
}
            \end{lstlisting}
        \end{block}
        \includegraphics<1>{sm-baseline-blank.pdf}
        \includegraphics<2>{sm-path-pfrz+pfrz.pdf}
        \includegraphics<3>{sm-path-pfrz+pfrz+pfrz.pdf}
        \includegraphics<4>{sm-path-pfrz+ub.pdf}
    \end{onlyenv}

    \begin{onlyenv}<5>
        \begin{block}{{\cmark} Base model}
            \begin{lstlisting}[language=rust]
fn read(x: &u64) -> u64 {
    let val = *x;
    opaque(/* assume no foreign write */);
    val
}
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-pfrz+pfrz+pfrz.pdf}
    \end{onlyenv}
\end{frame}

\subsection{Impossible optimizations}

\begin{frame}[fragile, t]
    \frametitle{Insert speculative write}

    \begin{onlyenv}<1-3>
        \begin{block}{{\xmark} Base model}
            \begin{lstlisting}[language=rust]
fn foo(x: &mut u64) {

    opaque(/* maybe foreign read/write */);
    *x = 42; // (optimization: move up ?)
}
            \end{lstlisting}
        \end{block}
        \includegraphics<1>{sm-path-pres+ub.pdf}
        \includegraphics<2>{sm-path-pres+pfrz+ub.pdf}
        \includegraphics<3>{sm-path-pres+pfrz.pdf}
    \end{onlyenv}
\end{frame}

\begin{frame}[fragile]
    \frametitle{Insert speculative write: strengthening}
    \begin{onlyenv}<1-2>
        \begin{exampleblock}{Possible strengthening}
            Write to mutable references of function entry
        \end{exampleblock}
        \includegraphics<1>[width=0.7\textwidth]{sm-full.pdf}
        \includegraphics<2>[width=0.7\textwidth]{sm-strengthening-act.pdf}
    \end{onlyenv}

    \begin{onlyenv}<3-4>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust]
fn foo(x: &mut u64) {

    opaque(/* maybe foreign read/write */);
    *x = 42;
}
            \end{lstlisting}
        \end{block}
        \includegraphics<3>{sm-path-st-pact.pdf}
        \includegraphics<4>{sm-path-st-pact+ub.pdf}
    \end{onlyenv}

    \begin{onlyenv}<5>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust]
fn foo(x: &mut u64) {
    *x = 42;
    opaque(/* assume no foreign read/write */);

}
            \end{lstlisting}
        \end{block}
        \includegraphics<5>{sm-path-st-pact+pact.pdf}
    \end{onlyenv}
\end{frame}

% FIXME: more space here
\begin{frame}[fragile]
    \frametitle{Insert speculative write: blocker}
    \begin{onlyenv}<1>
        \begin{block}{{\cmark} ``\texttt{as\_mut\_ptr}'' pattern}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
// as_mut_ptr: &mut [T] -> *mut T (does not actually write)
let raw = buffer.as_mut_ptr(); // creates raw: Reserved
let shr = buffer.as_ptr().add(1); // creates shr: Frozen
                             // raw stays Reserved (foreign read)
copy_nonoverlapping(shr, raw, 1); // raw gets activated
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<2>
        \begin{block}{{\xmark} ``\texttt{as\_mut\_ptr}'' pattern: strengthened model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
// as_mut_ptr: &mut [T] -> *mut T (may speculatively write)
let raw = buffer.as_mut_ptr(); // creates raw: Active
let shr = buffer.as_ptr().add(1); // creates shr: Frozen
                             // raw becomes Frozen (foreign read)
copy_nonoverlapping(shr, raw, 1); // write through Frozen: UB
            \end{lstlisting}
        \end{block}
    \end{onlyenv}
\end{frame}

\begin{frame}[fragile, t]
    \frametitle{Reorder write-read}
    \begin{block}{{\xmark} Base model}
        \begin{lstlisting}[language=rust]
let x = &mut ...;
*x = 42; // (optimization: move down ?)
let y = &...;
let vy = *y; // maybe foreign read ?

let vx = *x;
        \end{lstlisting}
    \end{block}
    \includegraphics{sm-path-res+act+actfrz.pdf}
\end{frame}

\begin{frame}[fragile, t]
    \frametitle{Reorder write-read: strengthening}
    \begin{onlyenv}<1-2>
        \begin{exampleblock}{Possible strengthening}
            Foreign read makes \texttt{Active} become \texttt{Disabled}
            (rather than \texttt{Frozen})
        \end{exampleblock}
        \includegraphics<1>{sm-base.pdf}
        \includegraphics<2>{sm-strengthening-dis.pdf}
    \end{onlyenv}

    \begin{onlyenv}<3-4>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust]
let x = &mut ...;
*x = 42; // (optimization: move down ?)
let y = &...;
let vy = *y; // maybe foreign read ?

let vx = *x;
            \end{lstlisting}
        \end{block}
        \includegraphics<3>{sm-path-st-res+act+Ract.pdf}
        \includegraphics<4>{sm-path-st-res+act+dis+Rub.pdf}
    \end{onlyenv}

    \begin{onlyenv}<5>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust]
let x = &mut ...;

let y = &...;
let vy = *y; // assumed not foreign
*x = 42;
let vx = *x;
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-st-res+act+Ract.pdf}
    \end{onlyenv}
\end{frame}

\begin{frame}[fragile, t]
    \frametitle{Reorder write-read: blocker}
    \begin{onlyenv}<1>
        \begin{block}{{\cmark} Reorder read-read\vphantom{gh}}
            \begin{lstlisting}[language=rust, escapechar=@]
let y = &mut *x;
*y = 42;
let vy = *y; // (optimization: move down ?)
let vx = *x; // foreign read
@@
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-res+act+Ract+frz.pdf}
    \end{onlyenv}

    \begin{onlyenv}<2>
        \begin{block}{{\cmark} Reorder read-read\vphantom{gh}}
            \begin{lstlisting}[language=rust]
let y = &mut *x;
*y = 42;

let vx = *x; // foreign read
let vy = *y;
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-res+act+frz+frz.pdf}
    \end{onlyenv}

    \begin{onlyenv}<3>
        \begin{block}{{\xmark} Reorder read-read: strengthened model}
            \begin{lstlisting}[language=rust, escapechar=@]
let y = &mut *x;
*y = 42;
let vy = *y;
let vx = *x; // foreign read
@@
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-st-res+act+Ract+dis.pdf}
    \end{onlyenv}

    \begin{onlyenv}<4>
        \begin{block}{{\xmark} Reorder read-read: strengthened model}
            \begin{lstlisting}[language=rust]
let y = &mut *x;
*y = 42;

let vx = *x; // foreign read
let vy = *y;
            \end{lstlisting}
        \end{block}
        \includegraphics{sm-path-st-res+act+dis+Rub.pdf}
    \end{onlyenv}
\end{frame}

\begin{frame}
    \frametitle{Summary}
    \begin{itemize}
        \item TB allows read reorderings (SB does not)
        \item TB allows speculative reads (SB as well)
        \item TB forbids speculative writes (SB allows them)
            \begin{itemize}
                \item the model can be strengthened to justify these optimizations...
                \item ...at the cost of common patterns.
            \end{itemize}
    \end{itemize}
\end{frame}
