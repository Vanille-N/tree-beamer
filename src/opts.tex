\section{Optimizations}

\begin{frame}
    \frametitle{Some standard optimizations}
    \begin{tabular}{|l|c|c|l}
        Possible in...                     & SB     & TB \\
        Insert speculative read            & \cmark & \cmark &\\
        Insert speculative write           & \cmark & \xmark &\visible<2>{\(\gets\)}\\
        Remove redundant read              & \cmark & \cmark &\\
        Remove redundant write             & \cmark & \cmark &\\
        Reorder read-write                 & \cmark & \xmark &\visible<2>{\(\gets\)}\\
        Reorder read-write (fn args)       & \cmark & \cmark &\\
        Reorder read-read                  & \xmark & \cmark &\visible<3>{\(\gets\)}\\
        Reorder read-read (fn args)        & \cmark & \cmark &\\
        Reorder write-write                & \cmark & \cmark &\\
        Reorder write-write (fn args)      & \cmark & \cmark &\\
        Reorder write-read                 & \cmark & \cmark &\\
        Reorder write-read (fn args)       & \cmark & \cmark &\\
        Reorder reborrow-reborrow          & \xmark & \cmark &\visible<3>{\(\gets\)}\\
    \end{tabular}
\end{frame}

\subsection{Possible optimizations}

\begin{frame}[fragile, t]
    \frametitle{{\cmark} Reorder write-any}
    \begin{onlyenv}<1>
        \begin{block}{}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;
// x: Reserved
*x = 42; // (optimization: move down ?)
// x: Active
*y = 19; // is this a foreign write ?
// x: Active|Disabled -> UB

*x = 57;
// x: Active (Disabled -> UB)
            \end{lstlisting}
        \end{block}
    \end{onlyenv}
    \begin{onlyenv}<2>
        \begin{block}{}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
let y = &mut ...;
// x: Reserved


*y = 19; // assumed not to be a foreign write
// x: Reserved|Frozen|Disabled
*x = 42;
*x = 57;
// x: Active (Frozen|Disabled -> UB)
            \end{lstlisting}
        \end{block}
    \end{onlyenv}
    \begin{onlyenv}<3>
        \begin{block}{}
            \begin{lstlisting}[language=rust, escapechar=@]
let x = &mut ...;
// x: Reserved


*y = 19; // assumed not to be a foreign write
// x: Reserved|Frozen|Disabled

*x = 57;
// x: Active (Frozen|Disabled -> UB)
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

\end{frame}

\begin{frame}[fragile, t]
    \frametitle{{\cmark} Insert speculative read}
    \begin{onlyenv}<1>
        \begin{block}{}
            \begin{lstlisting}[language=rust]
fn read(x: &u64) -> u64 {
    // x: [P] Frozen

    opaque(/* maybe foreign write */);
    // x: [P] Frozen (Disabled -> UB)
    *x // (optimization: move up ?)
}
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<2>
        \begin{block}{}
            \begin{lstlisting}[language=rust]
fn read(x: &u64) -> u64 {
    // x: [P] Frozen
    let val = *x;
    opaque(/* assume no foreign write */);
    // x: [P] Frozen
    val
}
            \end{lstlisting}
        \end{block}
    \end{onlyenv}
\end{frame}

\subsection{Impossible optimizations}

\begin{frame}[fragile, t]
    \frametitle{Insert speculative write}

    \begin{exampleblock}{Possible strengthening}
        Write to mutable references on function entry.
    \end{exampleblock}

    \begin{onlyenv}<1>
        \begin{block}{{\xmark} Base model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
fn foo(x: &mut u64) {
    // x: [P] Reserved

    opaque(/* maybe foreign read/write */);
    // x: [P] Reserved|Frozen (Disabled -> UB)
    *x = 42; // (optimization: move up ?)
}
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<2>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
fn foo(x: &mut u64) {
    // x: [P] Active

    opaque(/* maybe foreign read/write */);
    // x: [P] Active (Frozen|Disabled -> UB)
    *x = 42;
}
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<3>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
fn foo(x: &mut u64) {
    // x: [P] Active
    *x = 42;
    opaque(/* assume no foreign read/write */);
    // x: [P] Active (Frozen|Disabled -> UB)

}
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<4>
        \begin{block}{{\cmark} ``\texttt{as\_mut\_ptr}'' pattern}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
// as_mut_ptr: &mut [T] -> *mut T (does not actually write)
let raw = buffer.as_mut_ptr(); // creates raw: Reserved
let shr = buffer.as_ptr().add(1); // creates shr: Frozen
                             // raw stays Reserved (foreign read)
copy_nonoverlapping(shr, raw, 1); // raw gets activated
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<5>
        \begin{block}{{\xmark} ``\texttt{as\_mut\_ptr}'' pattern: strengthened model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
// as_mut_ptr: &mut [T] -> *mut T (may speculatively write)
let raw = buffer.as_mut_ptr(); // creates raw: Active
let shr = buffer.as_ptr().add(1); // creates shr: Frozen
                             // raw becomes Frozen (foreign read)
copy_nonoverlapping(shr, raw, 1); // write through Frozen: UB
            \end{lstlisting}
        \end{block}
    \end{onlyenv}
\end{frame}

\begin{frame}[fragile, t]
    \frametitle{Reorder write-read}
%%% possible
    \begin{exampleblock}{Possible strengthening}
        Foreign read makes \texttt{Active} become \texttt{Disabled}
        (rather than \texttt{Frozen})
    \end{exampleblock}


    \begin{onlyenv}<1>
        \begin{block}{{\xmark} Base model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
let x = &mut *y;
// x: Reserved
*x = 42; // (optimization: move down ?)
// x: Active
opaque(/* maybe foreign read/write */);
// x: Active|Frozen|Disabled


let _ = *x;
// x: Active|Frozen (Disabled -> UB)
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<2>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
let x = &mut *y;
// x: Reserved
*x = 42; // (optimization: move down ?)
// x: Active
opaque(/* maybe foreign read/write */);
// x: Active|Disabled


let _ = *x;
// x: Active (Disabled -> UB)
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<3>
        \begin{block}{{\cmark} Strengthened model}
            \begin{lstlisting}[language=rust, basicstyle=\ttfamily\scriptsize]
let x = &mut *y;
// x: Reserved


opaque(/* assume no foreign read/write */);
// x: Reserved
*x = 42;
// x: Active
let _ = *x;
// x: Active
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

%%% impossible

    \begin{onlyenv}<4>
        \begin{block}{{\cmark} Reorder read-read}
            \begin{lstlisting}[language=rust]
let x = &mut *z; // x: Reserved
*x = 42; // x: Active
let _ = *x; // x: Active (optimization: move down ?)
let _ = *z; // x: Frozen (foreign read)

            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<5>
        \begin{block}{{\cmark} Reorder read-read}
            \begin{lstlisting}[language=rust]
let x = &mut *z; // x: Reserved
*x = 42; // x: Active

let _ = *z; // x: Frozen (foreign read)
let _ = *x; // x: Frozen
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<6>
        \begin{block}{{\xmark} Reorder read-read: strengthened model}
            \begin{lstlisting}[language=rust]
let x = &mut *z; // x: Reserved
*x = 42; // x: Active
let _ = *x; // x: Active (optimization: move down ?)
let _ = *z; // x: Disabled (foreign read)

            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<7>
        \begin{block}{{\xmark} Reorder read-read: strengthened model}
            \begin{lstlisting}[language=rust]
let x = &mut *z; // x: Reserved
*x = 42; // x: Active

let _ = *z; // x: Disabled (foreign read)
let _ = *x; // Access through Disabled: UB!
            \end{lstlisting}
        \end{block}
    \end{onlyenv}
\end{frame}

\begin{frame}
    \frametitle{Summary}
    \begin{itemize}
        \item TB allows read reorderings (SB does not)
        \item TB allows speculative reads (SB as well)
        \item TB forbids speculative writes (SB allows them)
            \begin{itemize}
                \item the model can be strengthened to justify these optimizations...
                \item ...at the cost of common patterns.
            \end{itemize}
    \end{itemize}
\end{frame}
