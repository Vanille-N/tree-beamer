\section{Deriving rules}

\begin{frame}
    \frametitle{How many permissions ?}
    In short: one permission per ``kind of pointer''
    \begin{itemize}
        \item (interior) mutability,
        \item lifetime information,
        \item creation context,
        \item ...
    \end{itemize}~\\

    Guarantees required of pointers determine behavior of permissions:
    \begin{itemize}
        \item pointer allows mutation \\
            \(\qquad\Rightarrow\) permission allows child writes
        \item pointer guarantees uniqueness\\
            \(\qquad\Rightarrow\) permission prevents foreign accesses
        \item ...
    \end{itemize}
\end{frame}

\begin{frame}[t]
    \frametitle{Active, Frozen, Disabled}
    Core triplet of permissions to represent
    \begin{itemize}
        \item unique mutable references: \texttt{Active},
        \item shared immutable references: \texttt{Frozen},
        \item lifetime ended: \texttt{Disabled}.
    \end{itemize}

    \begin{onlyenv}<1>
        \begin{block}{Child read: must allow reading}
            \begin{itemize}
                \item \texttt{Active} \(\to\) \texttt{Active}
                \item \texttt{Frozen} \(\to\) \texttt{Frozen}
                \item \texttt{Disabled} \(\to\) UB
            \end{itemize}
        \end{block}

        \begin{block}{Child write: must allow writing}
            \begin{itemize}
                \item \texttt{Active} \(\to\) \texttt{Active}
                \item \texttt{Frozen} \(\to\) UB
                \item \texttt{Disabled} \(\to\) UB
            \end{itemize}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<2>
        \begin{block}{Foreign read: no longer unique}
            \begin{itemize}
                \item \texttt{Active} \(\to\) \texttt{Frozen}
                \item \texttt{Frozen} \(\to\) \texttt{Frozen}
                \item \texttt{Disabled} \(\to\) \texttt{Disabled}
            \end{itemize}
        \end{block}

        \begin{block}{Foreign write: no longer immutable}
            \begin{itemize}
                \item \texttt{Active} \(\to\) \texttt{Disabled}
                \item \texttt{Frozen} \(\to\) \texttt{Disabled}
                \item \texttt{Disabled} \(\to\) \texttt{Disabled}
            \end{itemize}
        \end{block}
    \end{onlyenv}
\end{frame}

\begin{frame}
    \frametitle{Parallel to the borrow checker}
    Similarities
    \hspace{-5em}
    \begin{description}
        \item[\cmark] \texttt{Active} (\texttt{\&mut}) readable and writeable
        \item[\cmark] \texttt{Frozen} (\texttt{\&}) and all their children are only readable
        \item[\cmark] data behind \texttt{Active} (\texttt{\&mut}) is owned exclusively
        \item[\cmark] data behind \texttt{Frozen} (\texttt{\&}) is immutable
    \end{description}~\\

    Differences (OK to be more permissive than the borrow checker)
    \hspace{-5em}
    \begin{description}
        \item[\xmark] \texttt{Active} (\texttt{\&mut}) demoted to \texttt{Frozen} (\texttt{\&})
        \item[\xmark] several \texttt{Active} (\texttt{\&mut}) can coexist if never written to
    \end{description}~\\

    Unsoundness (two following subsections fix them)
    \hspace{-5em}
    \begin{description}
        \item[\xmark] two-phase borrows not handled yet
        \item[\xmark] too permissive for \texttt{noalias} and \texttt{dereferenceable}
    \end{description}~\\

\end{frame}

\subsection{Fix unsoundness n°1: two-phase borrows}

\begin{frame}[fragile, t]
    \frametitle{Not all mutable references can be \texttt{Active}}
    \begin{alertblock}{Two-phase borrows}
        Mutable reborrows in function arguments tolerate shared reborrows
        until function entry.
    \end{alertblock}
    \begin{block}{Core triplet: unsound}
        \begin{minipage}{0.40\textwidth}
            \begin{lstlisting}[language=rust, escapechar=\@]
@              @fn main() {
@\visible<2>{\color{red}>}@    let mut v =
@\visible<2>{\color{red}>}@        vec![1usize];
@\visible<3,5>{\color{red}>}@    v.push(
@\visible<4,5>{\color{red}>}@        v.len()
@\visible<5>{\color{red}>}@    );
@              @}
            \end{lstlisting}
        \end{minipage}
        \vline
        \begin{minipage}{0.40\textwidth}
            \begin{tikzpicture}[
                every node/.append style = {anchor = west},
                grow via three points={one child at (0.3,-0.5) and two children at (0.3,-0.5) and (0.3,-1.0)},
                edge from parent path={(\tikzparentnode\tikzparentanchor) |- (\tikzchildnode\tikzchildanchor)}
                ]
                \node (nv) at (0,0) {\texttt{v:}}
                        child {node (nvpush) {\texttt{v\textsubscript{push}:}}}
                        child {node (nvlen) {\texttt{v\textsubscript{len}:}}};

                \node<2->[right of=nv] {\texttt{Active}};
                \node<3>[right of=nvpush] {~~\texttt{Active}};
                \node<4->[right of=nvpush] {~~\texttt{Frozen}};
                \node<4->[right of=nvlen] {~~\texttt{Frozen}};

                \node (vert) at (3,0 |- nv) {};
                \node<3,4> at (vert |- nv) {\(\gets\) reborrow};
                \node<4> at (vert |- nvlen) {\(\gets\) read};
                \node<5> at (vert |- nvpush) {\(\gets\) write (UB)};
            \end{tikzpicture}
        \end{minipage}
    \end{block}
\end{frame}

\begin{frame}
    \frametitle{New permission: \texttt{Reserved}}
    \begin{exampleblock}{Intuition}
        An \texttt{\&mut} not yet written to is not different from a \texttt{\&}.
    \end{exampleblock}

    A mutable reference not yet written to
    \begin{itemize}
        \item \texttt{Reserved} +child read \(\to\) \texttt{Reserved}
        \item \texttt{Reserved} +foreign read \(\to\) \texttt{Reserved}
        \item \texttt{Reserved} +foreign write \(\to\) \texttt{Disabled}
        \item \texttt{Reserved} +child write \(\to\) \texttt{Active}
    \end{itemize}
    \(\Rightarrow\) behaves as a \texttt{Frozen} until the first child write\\
    \(\Rightarrow\) can coexist with each other and with \texttt{Frozen}~\\~\\
\end{frame}

\begin{frame}[fragile, t]
    \frametitle{\texttt{Reserved} in action}
    \begin{alertblock}{Two-phase borrows}
        Mutable reborrows in function arguments tolerate shared reborrows
        until function entry.
    \end{alertblock}

    \begin{block}{Core triplet + \texttt{Reserved}: fixed}
        \begin{minipage}{0.4\textwidth}
            \begin{lstlisting}[language=rust, escapechar=\@]
@              @fn main() {
@\visible<2>{\color{red}>}@    let mut v =
@\visible<2>{\color{red}>}@        vec![1usize];
@\visible<3,5>{\color{red}>}@    v.push(
@\visible<4,5>{\color{red}>}@        v.len()
@\visible<5>{\color{red}>}@    );
@              @}
            \end{lstlisting}
        \end{minipage}
        \vline
        \begin{minipage}{0.40\textwidth}
            \begin{tikzpicture}[
                every node/.append style = {anchor = west},
                grow via three points={one child at (0.3,-0.5) and two children at (0.3,-0.5) and (0.3,-1.0)},
                edge from parent path={(\tikzparentnode\tikzparentanchor) |- (\tikzchildnode\tikzchildanchor)}
                ]
                \node (nv) at (0,0) {\texttt{v:}}
                        child {node (nvpush) {\texttt{v\textsubscript{push}:}}}
                        child {node (nvlen) {\texttt{v\textsubscript{len}:}}};

                \node<2->[right of=nv] {\texttt{Active}};
                \node<3,4>[right of=nvpush] {~~~~~\texttt{Reserved}};
                \node<5>[right of=nvpush] {~~\texttt{Active}};
                \node<4>[right of=nvlen] {~~\texttt{Frozen}};
                \node<5>[right of=nvlen] {~~~~\texttt{Disabled}};

                \node (vert) at (4,0 |- nv) {};
                \node<3,4> at (vert |- nv) {\(\gets\) reborrow};
                \node<4> at (vert |- nvlen) {\(\gets\) read};
                \node<5> at (vert |- nvpush) {\(\gets\) write};
            \end{tikzpicture}
        \end{minipage}
    \end{block}
\end{frame}

\subsection{Fix unsoundness n°2: justifying \texttt{noalias}}

\begin{frame}[fragile]
    \frametitle{Protectors lock permissions until the end of the function}
    \begin{onlyenv}<1>
        \begin{alertblock}{LLVM \texttt{noalias} (in TB terms)}
            No foreign access during the same function call as a child write.
        \end{alertblock}
        \begin{block}{Core triplet + \texttt{Reserved}: unsound}
            \begin{lstlisting}[language=rust, escapechar=@]
fn write(x: &mut u64) {
    *x = 42;   // x: Active
    opaque(/* foreign read for x */);
    // x: Frozen
    // `x` does not satisfy the requirements of `noalias`
}
            \end{lstlisting}
        \end{block}
    \end{onlyenv}

    \begin{onlyenv}<2>
        \begin{exampleblock}{Intuition}
            \texttt{noalias} requires exclusive access during the entire
            function call, so we remember the set of all functions that have not yet
            returned and enforce exclusivity for their arguments.
        \end{exampleblock}

        Concept adapted from Stacked Borrows: protectors.
        \begin{itemize}
            \item references get a protector on function entry
            \item protector lasts until the end of the call
        \end{itemize}
        ~\\
        While protected, behavior changes
        \begin{itemize}
            \item \(\texttt{Reserved}~\text{+foreign read}\to \cancel{\texttt{Reserved}}~\texttt{Frozen}\)
            \item \(\texttt{Reserved/Active/Frozen}~\text{+foreign write} \to \cancel{\texttt{Disabled}}~\text{UB}\)
            \item \(\texttt{Active}~\text{+foreign read}\to \cancel{\texttt{Frozen}}~\text{UB}\)
        \end{itemize}~\\
    \end{onlyenv}

    \begin{onlyenv}<3>
        \begin{alertblock}{LLVM \texttt{noalias} (in TB terms)}
            No foreign access during the same function call as a child write.
        \end{alertblock}

        \begin{block}{Core triplet + \texttt{Reserved} + protectors: fixed}
            \begin{lstlisting}[language=rust, escapechar=@]
fn write(x: &mut u64) {
    *x = 42; // x: [P] Active
    opaque(/* foreign read for x */);
    // x: [P] Frozen
    // UB: while x is protected,
    // Active -> Frozen is forbidden
}
            \end{lstlisting}
        \end{block}
    \end{onlyenv}
\end{frame}

\subsection*{}

\begin{frame}
    \frametitle{Summary}
    \begin{itemize}
        \item \texttt{Reserved}, \texttt{Active}, \texttt{Frozen}, \texttt{Disabled}
            represent different possible states of pointers.\\
        \item Interactions with child and foreign accesses enforce uniqueness/immutability guarantees.
        \item Protectors are added on function entry to strengthen these guarantees up to the
            requirements of \texttt{noalias}.\\
    \end{itemize}
\end{frame}
